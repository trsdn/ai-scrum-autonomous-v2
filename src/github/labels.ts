import { execGh, addComment } from "./issues.js";
import { logger } from "../logger.js";

/** Standard status labels used by the sprint runner. */
export const STATUS_LABELS = [
  "status:planned",
  "status:in-progress",
  "status:done",
  "status:blocked",
] as const;

export type StatusLabel = (typeof STATUS_LABELS)[number];

/** Add a label to an issue. */
export async function setLabel(
  issueNumber: number,
  label: string,
): Promise<void> {
  logger.debug({ issueNumber, label }, "Adding label");
  await execGh(["issue", "edit", String(issueNumber), "--add-label", label]);
}

/** Remove a label from an issue. */
export async function removeLabel(
  issueNumber: number,
  label: string,
): Promise<void> {
  logger.debug({ issueNumber, label }, "Removing label");
  await execGh([
    "issue",
    "edit",
    String(issueNumber),
    "--remove-label",
    label,
  ]);
}

/** Create a label if it doesn't already exist. */
export async function ensureLabelExists(
  name: string,
  color?: string,
  description?: string,
): Promise<void> {
  try {
    const json = await execGh([
      "label",
      "list",
      "--search",
      name,
      "--json",
      "name",
    ]);
    const labels = JSON.parse(json) as { name: string }[];
    const exists = labels.some((l) => l.name === name);

    if (exists) {
      logger.debug({ name }, "Label already exists");
      return;
    }
  } catch {
    // If listing fails, try creating anyway
  }

  const args = ["label", "create", name];
  if (color) {
    args.push("--color", color);
  }
  if (description) {
    args.push("--description", description);
  }
  args.push("--force");

  await execGh(args);
  logger.info({ name }, "Label created");
}

/** Get labels for a specific issue. */
export async function getLabels(
  issueNumber: number,
): Promise<{ name: string }[]> {
  const json = await execGh([
    "issue",
    "view",
    String(issueNumber),
    "--json",
    "labels",
  ]);
  const result = JSON.parse(json) as { labels?: { name: string }[] };
  return result.labels ?? [];
}

/** Set blocked status with documented reason. */
export async function setBlockedStatus(
  issueNumber: number,
  reason: string,
): Promise<void> {
  logger.debug({ issueNumber, reason }, "Setting blocked status with reason");
  await addComment(issueNumber, `ðŸš« **Blocked**: ${reason}`);
  await setLabel(issueNumber, "status:blocked");
}
