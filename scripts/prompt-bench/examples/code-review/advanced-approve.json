[
  {
    "id": "complex-refactor-with-tests-approve",
    "description": "Complex multi-file refactor with full test coverage \u2014 should be approved",
    "issueTitle": "Refactor event system to use EventEmitter pattern",
    "issueNumber": 301,
    "acceptanceCriteria": "- Custom event system replaced with EventEmitter\n- All event handlers migrated\n- Tests for emit, on, off, once\n- No behavior change for consumers",
    "diffStats": {
      "filesChanged": 8,
      "linesChanged": 150
    },
    "branch": "refactor/301-event-system",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/events/emitter.ts\n+++ b/src/events/emitter.ts\n@@ -1,15 +1,20 @@\n-const handlers: Record<string, Function[]> = {};\n-export function on(event: string, handler: Function) { handlers[event] = [...(handlers[event] ?? []), handler]; }\n-export function emit(event: string, data: unknown) { (handlers[event] ?? []).forEach(h => h(data)); }\n+import { EventEmitter } from \"node:events\";\n+\n+class TypedEmitter extends EventEmitter {\n+  emit(event: string, ...args: unknown[]): boolean {\n+    return super.emit(event, ...args);\n+  }\n+  on(event: string, listener: (...args: unknown[]) => void): this {\n+    return super.on(event, listener);\n+  }\n+}\n+\n+export const appEvents = new TypedEmitter();\n+appEvents.setMaxListeners(20);"
  },
  {
    "id": "error-code-mapping-approve",
    "description": "Adding error code to HTTP status mapping \u2014 should be approved",
    "issueTitle": "Map internal error codes to HTTP status codes",
    "issueNumber": 302,
    "acceptanceCriteria": "- Error codes mapped to appropriate HTTP statuses\n- User-friendly messages per code\n- Test for each error code mapping",
    "diffStats": {
      "filesChanged": 2,
      "linesChanged": 40
    },
    "branch": "feat/302-error-codes",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/errors/http-errors.ts\n+++ b/src/errors/http-errors.ts\n@@ -0,0 +1,18 @@\n+const errorCodeToStatus: Record<string, number> = {\n+  NOT_FOUND: 404,\n+  UNAUTHORIZED: 401,\n+  FORBIDDEN: 403,\n+  VALIDATION: 422,\n+  CONFLICT: 409,\n+  RATE_LIMITED: 429,\n+  INTERNAL: 500,\n+};\n+\n+export function toHttpStatus(code: string): number {\n+  return errorCodeToStatus[code] ?? 500;\n+}\n+\n+export function toUserMessage(code: string): string {\n+  const messages: Record<string, string> = { NOT_FOUND: \"Resource not found\", UNAUTHORIZED: \"Please log in\" };\n+  return messages[code] ?? \"An unexpected error occurred\";\n+}"
  },
  {
    "id": "middleware-chain-approve",
    "description": "Adding middleware chain for request processing \u2014 should be approved",
    "issueTitle": "Add middleware pipeline for API requests",
    "issueNumber": 303,
    "acceptanceCriteria": "- Middleware chain: auth \u2192 validate \u2192 handler \u2192 response\n- Middleware composable via use()\n- Tests for chain execution order",
    "diffStats": {
      "filesChanged": 3,
      "linesChanged": 60
    },
    "branch": "feat/303-middleware",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/middleware/pipeline.ts\n+++ b/src/middleware/pipeline.ts\n@@ -0,0 +1,15 @@\n+type Middleware = (ctx: RequestContext, next: () => Promise<void>) => Promise<void>;\n+\n+export class Pipeline {\n+  private middlewares: Middleware[] = [];\n+\n+  use(mw: Middleware): this { this.middlewares.push(mw); return this; }\n+\n+  async execute(ctx: RequestContext): Promise<void> {\n+    let index = 0;\n+    const next = async (): Promise<void> => {\n+      if (index < this.middlewares.length) await this.middlewares[index++](ctx, next);\n+    };\n+    await next();\n+  }\n+}"
  },
  {
    "id": "connection-pool-approve",
    "description": "Adding database connection pooling \u2014 should be approved",
    "issueTitle": "Add connection pool for database",
    "issueNumber": 304,
    "acceptanceCriteria": "- Pool size configurable (default 10)\n- Connections reused across requests\n- Pool drain on shutdown\n- Tests for pool lifecycle",
    "diffStats": {
      "filesChanged": 2,
      "linesChanged": 50
    },
    "branch": "feat/304-connection-pool",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/db/pool.ts\n+++ b/src/db/pool.ts\n@@ -0,0 +1,20 @@\n+import { Pool } from \"pg\";\n+\n+const pool = new Pool({\n+  connectionString: process.env.DATABASE_URL,\n+  max: parseInt(process.env.DB_POOL_SIZE ?? \"10\", 10),\n+  idleTimeoutMillis: 30_000,\n+  connectionTimeoutMillis: 5_000,\n+});\n+\n+pool.on(\"error\", (err) => {\n+  console.error(\"Unexpected pool error:\", err);\n+});\n+\n+export async function query<T>(text: string, params?: unknown[]): Promise<T[]> {\n+  const result = await pool.query(text, params);\n+  return result.rows;\n+}\n+\n+export async function drain(): Promise<void> { await pool.end(); }"
  },
  {
    "id": "structured-logging-approve",
    "description": "Replacing console.log with structured logger \u2014 should be approved",
    "issueTitle": "Replace console.log with pino logger",
    "issueNumber": 305,
    "acceptanceCriteria": "- All console.log replaced with pino logger\n- Log levels: debug, info, warn, error\n- JSON output in production, pretty in dev",
    "diffStats": {
      "filesChanged": 10,
      "linesChanged": 80
    },
    "branch": "chore/305-structured-logging",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/logger.ts\n+++ b/src/logger.ts\n@@ -1,3 +1,10 @@\n-export function log(msg: string) { console.log(msg); }\n+import pino from \"pino\";\n+\n+export const logger = pino({\n+  level: process.env.LOG_LEVEL ?? \"info\",\n+  transport: process.env.NODE_ENV === \"development\" ? { target: \"pino-pretty\" } : undefined,\n+});\n+\n+export type Logger = typeof logger;"
  },
  {
    "id": "api-versioning-approve",
    "description": "Adding API versioning \u2014 should be approved",
    "issueTitle": "Add v1 prefix to API routes",
    "issueNumber": 306,
    "acceptanceCriteria": "- All routes prefixed with /api/v1/\n- Old routes redirect to v1\n- Tests updated for new paths",
    "diffStats": {
      "filesChanged": 5,
      "linesChanged": 30
    },
    "branch": "feat/306-api-versioning",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/app.ts\n+++ b/src/app.ts\n@@ -5,6 +5,8 @@\n const app = express();\n app.use(express.json());\n-app.use(\"/api\", apiRouter);\n+app.use(\"/api/v1\", apiRouter);\n+// Redirect old paths\n+app.use(\"/api/users\", (req, res) => res.redirect(301, `/api/v1/users${req.url}`));"
  },
  {
    "id": "retry-circuit-breaker-approve",
    "description": "Adding circuit breaker pattern \u2014 should be approved",
    "issueTitle": "Add circuit breaker for external service calls",
    "issueNumber": 307,
    "acceptanceCriteria": "- Circuit opens after 3 consecutive failures\n- Half-open state after 30s cooldown\n- Tests for all states: closed, open, half-open",
    "diffStats": {
      "filesChanged": 2,
      "linesChanged": 70
    },
    "branch": "feat/307-circuit-breaker",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/utils/circuit-breaker.ts\n+++ b/src/utils/circuit-breaker.ts\n@@ -0,0 +1,30 @@\n+type State = \"closed\" | \"open\" | \"half-open\";\n+\n+export class CircuitBreaker {\n+  private state: State = \"closed\";\n+  private failures = 0;\n+  private lastFailure = 0;\n+\n+  constructor(private threshold = 3, private cooldownMs = 30_000) {}\n+\n+  async call<T>(fn: () => Promise<T>): Promise<T> {\n+    if (this.state === \"open\") {\n+      if (Date.now() - this.lastFailure > this.cooldownMs) {\n+        this.state = \"half-open\";\n+      } else {\n+        throw new Error(\"Circuit breaker is open\");\n+      }\n+    }\n+    try {\n+      const result = await fn();\n+      this.failures = 0;\n+      this.state = \"closed\";\n+      return result;\n+    } catch (err) {\n+      this.failures++;\n+      this.lastFailure = Date.now();\n+      if (this.failures >= this.threshold) this.state = \"open\";\n+      throw err;\n+    }\n+  }\n+}"
  },
  {
    "id": "cleanup-test-doubles-approve",
    "description": "Replacing hand-rolled mocks with vitest mocks \u2014 should be approved",
    "issueTitle": "Migrate test doubles to vitest mocks",
    "issueNumber": 308,
    "acceptanceCriteria": "- Hand-rolled mock classes replaced with vi.fn()\n- vi.mock() used for module mocking\n- No test behavior change",
    "diffStats": {
      "filesChanged": 6,
      "linesChanged": 100
    },
    "branch": "test/308-vitest-mocks",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/tests/services/order.test.ts\n+++ b/tests/services/order.test.ts\n@@ -1,15 +1,12 @@\n-class MockDb { findById = (id) => ({ id, name: \"test\" }); insert = (d) => d; }\n-class MockLogger { info() {} error() {} }\n+import { describe, it, expect, vi, beforeEach } from \"vitest\";\n+import { OrderService } from \"../../src/services/order\";\n \n describe(\"OrderService\", () => {\n+  const mockDb = { findById: vi.fn(), insert: vi.fn() };\n+  const mockLogger = { info: vi.fn(), error: vi.fn() };\n+\n   beforeEach(() => {\n-    db = new MockDb();\n-    logger = new MockLogger();\n+    vi.clearAllMocks();\n+    mockDb.findById.mockResolvedValue({ id: \"1\", name: \"test\" });\n   });"
  },
  {
    "id": "docker-compose-approve",
    "description": "Adding Docker Compose for local development \u2014 should be approved",
    "issueTitle": "Add docker-compose.yml for local dev",
    "issueNumber": 309,
    "acceptanceCriteria": "- docker-compose.yml with app + db services\n- Volume mounts for hot reload\n- README updated with Docker instructions",
    "diffStats": {
      "filesChanged": 3,
      "linesChanged": 50
    },
    "branch": "chore/309-docker-compose",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/docker-compose.yml\n+++ b/docker-compose.yml\n@@ -0,0 +1,18 @@\n+version: \"3.8\"\n+services:\n+  app:\n+    build: .\n+    ports:\n+      - \"3000:3000\"\n+    volumes:\n+      - .:/app\n+      - /app/node_modules\n+    environment:\n+      - DATABASE_URL=postgres://postgres:postgres@db:5432/myapp\n+    depends_on:\n+      - db\n+  db:\n+    image: postgres:16-alpine\n+    environment:\n+      POSTGRES_PASSWORD: postgres\n+      POSTGRES_DB: myapp"
  },
  {
    "id": "openapi-spec-approve",
    "description": "Adding OpenAPI specification \u2014 should be approved",
    "issueTitle": "Generate OpenAPI spec from route definitions",
    "issueNumber": 310,
    "acceptanceCriteria": "- OpenAPI 3.0 spec generated\n- All endpoints documented\n- Served at /api/docs\n- Test validates spec is valid JSON",
    "diffStats": {
      "filesChanged": 3,
      "linesChanged": 120
    },
    "branch": "docs/310-openapi",
    "expected": {
      "approved": true
    },
    "codeDiff": "--- a/src/docs/openapi.ts\n+++ b/src/docs/openapi.ts\n@@ -0,0 +1,20 @@\n+import { Router } from \"express\";\n+\n+const spec = {\n+  openapi: \"3.0.0\",\n+  info: { title: \"My API\", version: \"1.0.0\" },\n+  paths: {\n+    \"/api/v1/users\": {\n+      get: {\n+        summary: \"List users\",\n+        responses: { \"200\": { description: \"Success\" } },\n+      },\n+    },\n+  },\n+};\n+\n+const router = Router();\n+router.get(\"/api/docs\", (_req, res) => res.json(spec));\n+export default router;"
  }
]